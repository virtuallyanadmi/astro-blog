---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

const apiUrl = "https://my-sonicjs-app.going2timbuktu.workers.dev/api/content/posts?status=published";
let posts = [];

try {
  const response = await fetch(apiUrl);
  const result = await response.json();
  
  // Safely handle the case where data is missing or an error is returned
  const rawPosts = Array.isArray(result.data) ? result.data : [];

  posts = rawPosts.map((post: any) => ({
    slug: post.slug,
    data: {
      title: post.title,
      date: new Date(post.publishedAt || post.createdAt || Date.now()),
      teaser: post.excerpt || post.teaser || '',
    }
  })).sort((a: any, b: any) => b.data.date.valueOf() - a.data.date.valueOf());
} catch (e) {
  console.error("Failed to fetch posts:", e);
}

const latestPost = posts[0];
---

<BaseLayout>
  <Navigation slot="navigation" />
  
  <!-- ... rest of your HTML ... -->

  <div class="row t30">
    <div class="small-12 columns">
      <h3>Recent Posts</h3>
      {posts.length > 0 ? (
        <ul>
          {posts.slice(0, 10).map((post: any) => (
            <li>
              <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
            </li>
          ))}
        </ul>
      ) : (
        <p>No posts found. Time to run the migration script!</p>
      )}
    </div>
  </div>

  <Footer slot="footer" />
</BaseLayout>