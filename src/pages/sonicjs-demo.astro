---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { sonicjs, type SonicJSPost } from '../lib/sonicjs';

let posts: SonicJSPost[] = [];
let error: string | null = null;

try {
  posts = await sonicjs.getPosts();
} catch (e) {
  error = (e as Error).message;
  console.error('Error fetching SonicJS posts:', e);
}
---

<BaseLayout title="SonicJS Content Demo" description="Dynamic content from SonicJS CMS">
  <Navigation slot="navigation" />
  
  <div class="row t30">
    <div class="medium-8 columns medium-offset-2 end">
      <article>
        <header>
          <h1>SonicJS Content Demo</h1>
          <p class="subheadline">Dynamic content powered by SonicJS CMS</p>
        </header>

        {error ? (
          <div class="alert-box warning">
            <h3>‚ö†Ô∏è SonicJS Connection Issue</h3>
            <p><strong>Error:</strong> {error}</p>
            <p>This is expected if you haven't set up SonicJS content yet. SonicJS is optional and your static blog posts work perfectly without it!</p>

            <h4>Want to use SonicJS for dynamic content?</h4>
            <ol>
              <li>Register at: <a href="https://my-sonicjs-app.going2timbuktu.workers.dev/auth/register" target="_blank">SonicJS Admin</a></li>
              <li>Log in and create content types (e.g., "Blog Posts")</li>
              <li>Create some content in the admin dashboard</li>
              <li>Rebuild your site: <code>npm run build</code></li>
              <li>Your dynamic content will appear here!</li>
            </ol>

            <p><strong>Note:</strong> No API key needed! SonicJS uses session-based authentication.</p>
          </div>
        ) : posts.length === 0 ? (
          <div class="alert-box info">
            <h3>üìù No Content Yet</h3>
            <p>You're connected to SonicJS, but haven't created any content yet.</p>
            <p>Visit the <a href="https://my-sonicjs-app.going2timbuktu.workers.dev" target="_blank">SonicJS Admin</a> to:</p>
            <ul>
              <li>Define content types (collections)</li>
              <li>Create your first post</li>
              <li>Manage your dynamic content</li>
            </ul>
            <p>Then rebuild your site to see the content here!</p>
          </div>
        ) : (
          <div>
            <h2>Posts from SonicJS ({posts.length})</h2>
            <div class="posts-grid">
              {posts.map((post) => (
                <article class="post-card">
                  {post.image?.url && (
                    <img src={post.image.url} alt={post.image.alt || post.title} />
                  )}
                  <h3>{post.title}</h3>
                  {post.excerpt && <p>{post.excerpt}</p>}
                  <div class="meta">
                    {post.author && <span>By {post.author}</span>}
                    {post.date && <span> ‚Ä¢ {new Date(post.date).toLocaleDateString()}</span>}
                  </div>
                  {post.tags && post.tags.length > 0 && (
                    <div class="tags">
                      {post.tags.map((tag: string) => (
                        <span class="tag">{tag}</span>
                      ))}
                    </div>
                  )}
                </article>
              ))}
            </div>
          </div>
        )}

        <div class="info-box">
          <h3>üöÄ About This Demo</h3>
          <p>This page demonstrates the integration between your Astro site and SonicJS CMS:</p>
          <ul>
            <li><strong>Static Site Generation:</strong> Content is fetched at build time</li>
            <li><strong>Edge-Native CMS:</strong> SonicJS runs on Cloudflare Workers</li>
            <li><strong>Sub-100ms Response:</strong> Lightning-fast API responses</li>
            <li><strong>Hybrid Approach:</strong> Mix static content collections with dynamic SonicJS content</li>
            <li><strong>No API Keys:</strong> SonicJS uses session-based authentication for the admin panel</li>
          </ul>

          <h4>Your Current Setup:</h4>
          <ul>
            <li>‚úÖ <strong>Static Blog:</strong> 38+ posts from content collections</li>
            <li>‚úÖ <strong>R2 CDN:</strong> Assets served from Cloudflare globally</li>
            <li>‚úÖ <strong>SonicJS Ready:</strong> Add dynamic content anytime</li>
          </ul>

          <p><strong>SonicJS Admin:</strong> <a href="https://my-sonicjs-app.going2timbuktu.workers.dev" target="_blank">https://my-sonicjs-app.going2timbuktu.workers.dev</a></p>
            <li><strong>Edge-Native CMS:</strong> SonicJS runs on Cloudflare Workers</li>
            <li><strong>Sub-100ms Response:</strong> Lightning-fast API responses</li>
            <li><strong>Hybrid Approach:</strong> Mix static content collections with dynamic SonicJS content</li>
          </ul>
        </div>
      </article>
    </div>
  </div>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .alert-box {
    padding: 1.5rem;
    margin: 2rem 0;
    border-radius: 8px;
    border-left: 4px solid;
  }
  
  .alert-box.warning {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
  }
  
  .alert-box.info {
    background-color: #d1ecf1;
    border-color: #17a2b8;
    color: #0c5460;
  }
  
  .alert-box h3 {
    margin-top: 0;
  }
  
  .alert-box code {
    background-color: rgba(0,0,0,0.1);
    padding: 2px 6px;
    border-radius: 3px;
  }
  
  .posts-grid {
    display: grid;
    gap: 2rem;
    margin: 2rem 0;
  }
  
  .post-card {
    padding: 1.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fff;
  }
  
  .post-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 1rem;
  }
  
  .post-card h3 {
    margin: 0 0 0.5rem 0;
  }
  
  .meta {
    color: #666;
    font-size: 0.9rem;
    margin: 0.5rem 0;
  }
  
  .tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  
  .tag {
    background-color: #e0e0e0;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
  }
  
  .info-box {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 2rem;
  }
  
  .info-box h3 {
    margin-top: 0;
  }
</style>
