---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navigation from '../../components/Navigation.astro';
import Footer from '../../components/Footer.astro';
import { getImageUrl } from '../../lib/cdn';

export async function getStaticPaths() {
  const apiUrl = "https://my-sonicjs-app.going2timbuktu.workers.dev/api/content/posts?status=published";
  
  try {
    const response = await fetch(apiUrl);
    const result = await response.json();
    
    // SonicJs usually returns { data: [...] }
    // We check if result.data exists and is an array
    const posts = Array.isArray(result.data) ? result.data : [];
    
    if (posts.length === 0) {
      console.warn("No posts found from SonicJs API:", result);
      return [];
    }

    return posts.map((post: any) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error("Error fetching posts from SonicJs:", error);
    return [];
  }
}

const { post } = Astro.props as { post: any };

// Map SonicJs fields to your existing schema with safe fallbacks
const postData = {
  title: post.title || '',
  teaser: post.excerpt || post.teaser || '',
  subheadline: post.subheadline || '',
  date: new Date(post.publishedAt || post.createdAt || Date.now()),
  author: post.author?.name || 'jonathan',
  image: post.featuredImage ? { title: post.featuredImage } : null,
  content: post.content || '',
  tags: post.tags || []
};
---

<BaseLayout title={postData.title} description={postData.teaser}>
  <Navigation slot="navigation" />
  
  <div class="row t30">
    <div class="medium-8 columns medium-offset-2 end">
      <article itemscope itemtype="http://schema.org/Article">
        <header>
          {postData.image?.title && (
            <figure>
              <img src={getImageUrl(postData.image.title)} width="970" alt={postData.title} itemprop="image" />
            </figure>
          )}
          
          <span itemprop="name">
            {postData.subheadline && <p class="subheadline">{postData.subheadline}</p>}
            <h1>{postData.title}</h1>
          </span>
          
          <p class="meta-info">
            <time datetime={postData.date.toISOString()}>
              {postData.date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}
            </time>
            {postData.author && ` by ${postData.author}`}
          </p>
        </header>

        {postData.teaser && (
          <p class="teaser" itemprop="description">
            {postData.teaser}
          </p>
        )}

        <div class="content" itemprop="articleSection" set:html={postData.content} />
        
        {postData.tags.length > 0 && (
          <div class="tags">
            <strong>Tags:</strong> {postData.tags.join(', ')}
          </div>
        )}
      </article>
    </div>
  </div>

  <Footer slot="footer" />
</BaseLayout>